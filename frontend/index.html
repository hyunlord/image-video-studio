<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FramePack Video Studio</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body {
            background-color: #111827;
            color: #f3f4f6;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
        }
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .sortable-ghost {
            opacity: 0.4;
        }
        .sortable-chosen {
            cursor: grabbing;
        }
        .drag-over {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // API Base URL (change if needed)
        const API_BASE = '';
        const WS_BASE = window.location.protocol === 'https:' ? 'wss://' : 'ws://';

        // Utility Functions
        const formatFileSize = (bytes) => {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        };

        const formatETA = (seconds) => {
            if (!seconds || seconds < 0) return '';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            if (mins > 0) return `ì•½ ${mins}ë¶„ ${secs}ì´ˆ`;
            return `ì•½ ${secs}ì´ˆ`;
        };

        // ImageUploader Component
        const ImageUploader = ({ onUploadComplete, systemConfig }) => {
            const [uploading, setUploading] = useState(false);
            const [uploadProgress, setUploadProgress] = useState(0);
            const [dragOver, setDragOver] = useState(false);
            const fileInputRef = useRef(null);

            const handleFiles = async (files) => {
                if (!files || files.length === 0) return;

                setUploading(true);
                setUploadProgress(0);

                const formData = new FormData();
                Array.from(files).forEach(file => {
                    formData.append('files', file);
                });

                try {
                    const response = await fetch(`${API_BASE}/api/upload`, {
                        method: 'POST',
                        body: formData,
                    });

                    if (!response.ok) throw new Error('ì—…ë¡œë“œ ì‹¤íŒ¨');

                    const data = await response.json();
                    onUploadComplete(data.images);
                } catch (error) {
                    alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                } finally {
                    setUploading(false);
                    setUploadProgress(0);
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setDragOver(false);
                handleFiles(e.dataTransfer.files);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                setDragOver(true);
            };

            const handleDragLeave = () => {
                setDragOver(false);
            };

            return (
                <div
                    className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors ${
                        dragOver ? 'drag-over' : 'border-gray-600 hover:border-gray-500'
                    }`}
                    onDrop={handleDrop}
                    onDragOver={handleDragOver}
                    onDragLeave={handleDragLeave}
                >
                    <input
                        ref={fileInputRef}
                        type="file"
                        multiple
                        accept="image/*"
                        className="hidden"
                        onChange={(e) => handleFiles(e.target.files)}
                    />

                    {uploading ? (
                        <div className="space-y-4">
                            <div className="text-blue-400">ì—…ë¡œë“œ ì¤‘...</div>
                            <div className="w-full bg-gray-700 rounded-full h-2">
                                <div
                                    className="bg-blue-500 h-2 rounded-full transition-all duration-300"
                                    style={{ width: `${uploadProgress}%` }}
                                />
                            </div>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            <svg className="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                            </svg>
                            <div className="text-gray-300">
                                ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ
                            </div>
                            <button
                                onClick={() => fileInputRef.current?.click()}
                                className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors"
                            >
                                íŒŒì¼ ì„ íƒ
                            </button>
                            <div className="text-sm text-gray-500">
                                ìµœì†Œ 2ê°œ ì´ìƒì˜ ì´ë¯¸ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ImageReorderer Component
        const ImageReorderer = ({ images, onReorder, onDelete }) => {
            const sortableRef = useRef(null);
            const sortableInstance = useRef(null);

            useEffect(() => {
                if (sortableRef.current && images.length > 0) {
                    sortableInstance.current = Sortable.create(sortableRef.current, {
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        onEnd: (evt) => {
                            const newImages = [...images];
                            const [moved] = newImages.splice(evt.oldIndex, 1);
                            newImages.splice(evt.newIndex, 0, moved);
                            onReorder(newImages);
                        }
                    });
                }

                return () => {
                    if (sortableInstance.current) {
                        sortableInstance.current.destroy();
                    }
                };
            }, [images.length]);

            if (images.length === 0) return null;

            return (
                <div className="space-y-4">
                    <div className="flex items-center justify-between">
                        <h3 className="text-lg font-semibold">ì´ë¯¸ì§€ ìˆœì„œ ì¡°ì •</h3>
                        <div className="text-sm text-gray-400">
                            ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½ ({images.length}ê°œ)
                        </div>
                    </div>

                    <div ref={sortableRef} className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        {images.map((img, idx) => (
                            <div key={img.id} className="relative group cursor-move">
                                <div className="aspect-square bg-gray-700 rounded-lg overflow-hidden">
                                    <img
                                        src={img.url}
                                        alt={img.filename}
                                        className="w-full h-full object-cover"
                                    />
                                </div>
                                <div className="absolute top-2 left-2 bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-semibold">
                                    {idx + 1}
                                </div>
                                <button
                                    onClick={() => onDelete(img.id)}
                                    className="absolute top-2 right-2 bg-red-600 hover:bg-red-700 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
                                >
                                    Ã—
                                </button>
                                {idx < images.length - 1 && (
                                    <div className="absolute -right-2 top-1/2 transform -translate-y-1/2 text-blue-400 hidden md:block">
                                        â†’
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    {images.length >= 2 && (
                        <div className="text-sm text-gray-400 text-center">
                            ì´ {images.length - 1}ê°œì˜ ì „í™˜ í˜ì–´ê°€ ìƒì„±ë©ë‹ˆë‹¤
                        </div>
                    )}
                </div>
            );
        };

        // ParameterPanel Component
        const ParameterPanel = ({ systemConfig, onGenerate, disabled }) => {
            const [videoLength, setVideoLength] = useState('short');
            const [videoQuality, setVideoQuality] = useState('standard');
            const [transitionIntensity, setTransitionIntensity] = useState('normal');
            const [prompt, setPrompt] = useState('');
            const [showAdvanced, setShowAdvanced] = useState(false);
            const [postProcess, setPostProcess] = useState('auto');
            const [faceRestore, setFaceRestore] = useState(null);
            const [upscale, setUpscale] = useState(null);
            const [interpolate, setInterpolate] = useState(null);
            const [seed, setSeed] = useState('');

            const isLongDisabled = systemConfig && systemConfig.max_frames < 81;
            const showHDWarning = videoQuality === 'hd' && systemConfig?.gpu_tier === 'T4';

            const promptPresets = [
                { label: 'ìì—°ìŠ¤ëŸ¬ìš´ ë³€í™”', value: 'ì´ë¯¸ì§€ë“¤ì´ ìì—°ìŠ¤ëŸ½ê²Œ ë³€í™”í•©ë‹ˆë‹¤' },
                { label: 'ê·¹ì ì¸ ë³€ì‹ ', value: 'ê·¹ì ì´ê³  ì¸ìƒì ì¸ ë³€í™”ê°€ ì¼ì–´ë‚©ë‹ˆë‹¤' },
                { label: 'ê³„ì ˆ ë³€í™”', value: 'ê³„ì ˆì´ ìì—°ìŠ¤ëŸ½ê²Œ ë³€í™”í•˜ëŠ” ì¥ë©´ì…ë‹ˆë‹¤' }
            ];

            const handleGenerate = () => {
                const params = {
                    prompt,
                    video_length: videoLength,
                    video_quality: videoQuality,
                    transition_intensity: transitionIntensity,
                    post_process: postProcess,
                    post_process_options: {
                        face_restore: faceRestore,
                        upscale: upscale,
                        interpolate: interpolate
                    },
                    seed: seed ? parseInt(seed) : null
                };
                onGenerate(params);
            };

            return (
                <div className="bg-gray-800 rounded-lg p-6 space-y-6">
                    <h3 className="text-xl font-semibold">ìƒì„± ì„¤ì •</h3>

                    {/* Video Length */}
                    <div className="space-y-3">
                        <label className="block text-sm font-medium">ì˜ìƒ ê¸¸ì´</label>
                        <div className="grid grid-cols-3 gap-3">
                            {['short', 'medium', 'long'].map((len) => {
                                const labels = { short: 'ì§§ê²Œ', medium: 'ë³´í†µ', long: 'ê¸¸ê²Œ' };
                                const durations = { short: '~1ì´ˆ', medium: '~2ì´ˆ', long: '~3ì´ˆ' };
                                const isDisabled = len === 'long' && isLongDisabled;

                                return (
                                    <button
                                        key={len}
                                        disabled={isDisabled}
                                        onClick={() => !isDisabled && setVideoLength(len)}
                                        className={`p-4 rounded-lg border-2 transition-all ${
                                            videoLength === len
                                                ? 'border-blue-500 bg-blue-900/30'
                                                : 'border-gray-600 hover:border-gray-500'
                                        } ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}`}
                                        title={isDisabled ? 'GPU ì œí•œ' : ''}
                                    >
                                        <div className="font-semibold">{labels[len]}</div>
                                        <div className="text-sm text-gray-400">{durations[len]}</div>
                                        {isDisabled && <div className="text-xs text-red-400 mt-1">GPU ì œí•œ</div>}
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {/* Video Quality */}
                    <div className="space-y-3">
                        <label className="block text-sm font-medium">ì˜ìƒ í’ˆì§ˆ</label>
                        <div className="flex gap-3">
                            <button
                                onClick={() => setVideoQuality('standard')}
                                className={`flex-1 p-4 rounded-lg border-2 transition-all ${
                                    videoQuality === 'standard'
                                        ? 'border-blue-500 bg-blue-900/30'
                                        : 'border-gray-600 hover:border-gray-500'
                                }`}
                            >
                                <div className="font-semibold">ì¼ë°˜</div>
                                <div className="text-sm text-gray-400">480P</div>
                            </button>
                            <button
                                onClick={() => setVideoQuality('hd')}
                                className={`flex-1 p-4 rounded-lg border-2 transition-all ${
                                    videoQuality === 'hd'
                                        ? 'border-blue-500 bg-blue-900/30'
                                        : 'border-gray-600 hover:border-gray-500'
                                }`}
                            >
                                <div className="font-semibold">ê³ í™”ì§ˆ</div>
                                <div className="text-sm text-gray-400">720P</div>
                            </button>
                        </div>
                        {showHDWarning && (
                            <div className="text-sm text-yellow-400 bg-yellow-900/20 p-3 rounded">
                                âš ï¸ T4 GPUì—ì„œëŠ” ê³ í™”ì§ˆ ìƒì„±ì— ì‹œê°„ì´ ë” ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                            </div>
                        )}
                    </div>

                    {/* Transition Intensity */}
                    <div className="space-y-3">
                        <label className="block text-sm font-medium">ë³€í™˜ ê°•ë„</label>
                        <div className="grid grid-cols-3 gap-3">
                            {[
                                { value: 'gentle', label: 'ë¶€ë“œëŸ½ê²Œ' },
                                { value: 'normal', label: 'ë³´í†µ' },
                                { value: 'dynamic', label: 'ì—­ë™ì ' }
                            ].map(({ value, label }) => (
                                <button
                                    key={value}
                                    onClick={() => setTransitionIntensity(value)}
                                    className={`p-3 rounded-lg border-2 transition-all ${
                                        transitionIntensity === value
                                            ? 'border-blue-500 bg-blue-900/30'
                                            : 'border-gray-600 hover:border-gray-500'
                                    }`}
                                >
                                    {label}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Prompt */}
                    <div className="space-y-3">
                        <label className="block text-sm font-medium">ë³€í™” ì„¤ëª…</label>
                        <textarea
                            value={prompt}
                            onChange={(e) => setPrompt(e.target.value)}
                            placeholder="ì˜ˆ: ì‚¬ëŒì´ ìì—°ìŠ¤ëŸ½ê²Œ ë‚˜ì´ê°€ ë“¤ì–´ê°„ë‹¤"
                            className="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-gray-100 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="3"
                        />
                        <div className="flex flex-wrap gap-2">
                            {promptPresets.map((preset) => (
                                <button
                                    key={preset.label}
                                    onClick={() => setPrompt(preset.value)}
                                    className="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded transition-colors"
                                >
                                    {preset.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Advanced Settings */}
                    <div className="space-y-3">
                        <button
                            onClick={() => setShowAdvanced(!showAdvanced)}
                            className="flex items-center gap-2 text-sm text-gray-400 hover:text-gray-300"
                        >
                            <span>{showAdvanced ? 'â–¼' : 'â–¶'}</span>
                            ê³ ê¸‰ ì„¤ì •
                        </button>

                        {showAdvanced && (
                            <div className="space-y-4 pl-4 border-l-2 border-gray-700">
                                {/* Post Process Mode */}
                                <div className="space-y-2">
                                    <label className="block text-sm font-medium">í›„ì²˜ë¦¬ ëª¨ë“œ</label>
                                    <div className="grid grid-cols-3 gap-2">
                                        {[
                                            { value: 'auto', label: 'ìë™' },
                                            { value: 'manual', label: 'ìˆ˜ë™' },
                                            { value: 'off', label: 'ë„ê¸°' }
                                        ].map(({ value, label }) => (
                                            <button
                                                key={value}
                                                onClick={() => setPostProcess(value)}
                                                className={`p-2 rounded border transition-all text-sm ${
                                                    postProcess === value
                                                        ? 'border-blue-500 bg-blue-900/30'
                                                        : 'border-gray-600 hover:border-gray-500'
                                                }`}
                                            >
                                                {label}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Manual Options */}
                                {postProcess === 'manual' && (
                                    <div className="space-y-3">
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={faceRestore === true}
                                                onChange={(e) => setFaceRestore(e.target.checked ? true : null)}
                                                className="w-4 h-4 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-blue-500"
                                            />
                                            <span className="text-sm">ì–¼êµ´ ë³µì›</span>
                                        </label>
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={upscale === true}
                                                onChange={(e) => setUpscale(e.target.checked ? true : null)}
                                                className="w-4 h-4 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-blue-500"
                                            />
                                            <span className="text-sm">ì—…ìŠ¤ì¼€ì¼</span>
                                        </label>
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={interpolate === true}
                                                onChange={(e) => setInterpolate(e.target.checked ? true : null)}
                                                className="w-4 h-4 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-blue-500"
                                            />
                                            <span className="text-sm">í”„ë ˆì„ ë³´ê°„</span>
                                        </label>
                                    </div>
                                )}

                                {/* Seed */}
                                <div className="space-y-2">
                                    <label className="block text-sm font-medium">ì‹œë“œ (ì„ íƒì‚¬í•­)</label>
                                    <input
                                        type="number"
                                        value={seed}
                                        onChange={(e) => setSeed(e.target.value)}
                                        placeholder="ëœë¤"
                                        className="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-gray-100 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Generate Button */}
                    <button
                        onClick={handleGenerate}
                        disabled={disabled}
                        className={`w-full py-4 rounded-lg font-semibold transition-all ${
                            disabled
                                ? 'bg-gray-600 cursor-not-allowed'
                                : 'bg-blue-600 hover:bg-blue-700 active:scale-95'
                        }`}
                    >
                        ìƒì„±í•˜ê¸°
                    </button>
                </div>
            );
        };

        // ProgressTracker Component
        const ProgressTracker = ({ job, onCancel }) => {
            if (!job || job.status === 'completed' || job.status === 'failed') return null;

            const stages = [
                { key: 'preprocessing', label: 'ì „ì²˜ë¦¬' },
                { key: 'generation', label: 'ìƒì„±' },
                { key: 'postprocessing', label: 'í›„ì²˜ë¦¬' }
            ];

            const currentStageIndex = stages.findIndex(s => s.key === job.stage);
            const progress = job.progress || 0;

            return (
                <div className="bg-gray-800 rounded-lg p-6 space-y-4">
                    <div className="flex items-center justify-between">
                        <h3 className="text-lg font-semibold">ì²˜ë¦¬ ì¤‘</h3>
                        <button
                            onClick={() => onCancel(job.job_id)}
                            className="text-sm bg-red-600 hover:bg-red-700 px-4 py-2 rounded transition-colors"
                        >
                            ì·¨ì†Œ
                        </button>
                    </div>

                    {/* Stage Progress */}
                    <div className="flex items-center justify-between">
                        {stages.map((stage, idx) => (
                            <React.Fragment key={stage.key}>
                                <div className="flex flex-col items-center">
                                    <div
                                        className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${
                                            idx < currentStageIndex
                                                ? 'bg-green-600'
                                                : idx === currentStageIndex
                                                ? 'bg-blue-600 pulse-animation'
                                                : 'bg-gray-600'
                                        }`}
                                    >
                                        {idx < currentStageIndex ? 'âœ“' : idx + 1}
                                    </div>
                                    <div className="text-xs mt-2 text-gray-400">{stage.label}</div>
                                </div>
                                {idx < stages.length - 1 && (
                                    <div className="flex-1 h-1 mx-2 bg-gray-700 rounded">
                                        <div
                                            className={`h-full rounded transition-all ${
                                                idx < currentStageIndex ? 'bg-green-600 w-full' : 'w-0'
                                            }`}
                                        />
                                    </div>
                                )}
                            </React.Fragment>
                        ))}
                    </div>

                    {/* Progress Bar */}
                    <div className="space-y-2">
                        <div className="flex justify-between text-sm">
                            <span>{Math.round(progress)}%</span>
                            {job.eta_seconds && <span>{formatETA(job.eta_seconds)}</span>}
                        </div>
                        <div className="w-full bg-gray-700 rounded-full h-3">
                            <div
                                className="bg-blue-600 h-3 rounded-full transition-all duration-300"
                                style={{ width: `${progress}%` }}
                            />
                        </div>
                    </div>

                    {/* Current Pair */}
                    {job.total_pairs > 0 && (
                        <div className="text-sm text-gray-400 text-center">
                            í˜ì–´ {job.current_pair || 0}/{job.total_pairs}
                        </div>
                    )}

                    {/* Message */}
                    {job.message && (
                        <div className="text-sm text-gray-400 text-center">
                            {job.message}
                        </div>
                    )}
                </div>
            );
        };

        // VideoPlayer Component
        const VideoPlayer = ({ job }) => {
            if (!job || job.status !== 'completed' || !job.video_url) return null;

            const handleDownload = () => {
                const link = document.createElement('a');
                link.href = `${API_BASE}/api/videos/${job.job_id}/download`;
                link.download = `video_${job.job_id}.mp4`;
                link.click();
            };

            return (
                <div className="bg-gray-800 rounded-lg p-6 space-y-4">
                    <h3 className="text-lg font-semibold text-green-400">ìƒì„± ì™„ë£Œ!</h3>

                    <video
                        controls
                        className="w-full rounded-lg bg-black"
                        src={job.video_url}
                    >
                        ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </video>

                    <button
                        onClick={handleDownload}
                        className="w-full bg-green-600 hover:bg-green-700 py-3 rounded-lg font-semibold transition-colors"
                    >
                        ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
            );
        };

        // BatchQueue Component
        const BatchQueue = ({ jobs, onSelectJob }) => {
            if (jobs.length === 0) return null;

            const statusConfig = {
                pending: { label: 'ëŒ€ê¸°', color: 'bg-gray-600' },
                processing: { label: 'ì²˜ë¦¬ì¤‘', color: 'bg-blue-600 pulse-animation' },
                completed: { label: 'ì™„ë£Œ', color: 'bg-green-600' },
                failed: { label: 'ì‹¤íŒ¨', color: 'bg-red-600' },
                cancelled: { label: 'ì·¨ì†Œë¨', color: 'bg-gray-500' }
            };

            return (
                <div className="bg-gray-800 rounded-lg p-6 space-y-4">
                    <h3 className="text-lg font-semibold">ì‘ì—… ëª©ë¡</h3>

                    <div className="space-y-2 max-h-96 overflow-y-auto">
                        {jobs.map((job) => {
                            const config = statusConfig[job.status] || statusConfig.pending;
                            const isClickable = job.status === 'completed';

                            return (
                                <div
                                    key={job.job_id}
                                    onClick={() => isClickable && onSelectJob(job)}
                                    className={`p-4 bg-gray-700 rounded-lg flex items-center justify-between ${
                                        isClickable ? 'cursor-pointer hover:bg-gray-600' : ''
                                    }`}
                                >
                                    <div className="flex-1">
                                        <div className="text-sm font-mono text-gray-400">
                                            {job.job_id.substring(0, 8)}
                                        </div>
                                        {job.error && (
                                            <div className="text-sm text-red-400 mt-1">
                                                {job.error}
                                            </div>
                                        )}
                                    </div>
                                    <div className={`px-3 py-1 rounded-full text-sm ${config.color}`}>
                                        {config.label}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [systemConfig, setSystemConfig] = useState(null);
            const [images, setImages] = useState([]);
            const [jobs, setJobs] = useState([]);
            const [activeJob, setActiveJob] = useState(null);
            const [selectedJob, setSelectedJob] = useState(null);
            const wsRef = useRef(null);
            const wsReconnectAttempts = useRef(0);

            // Load system config on mount
            useEffect(() => {
                fetch(`${API_BASE}/api/system/config`)
                    .then(res => res.json())
                    .then(data => setSystemConfig(data))
                    .catch(err => console.error('Failed to load system config:', err));

                // Load existing images
                fetch(`${API_BASE}/api/images`)
                    .then(res => res.json())
                    .then(data => setImages(data.images || []))
                    .catch(err => console.error('Failed to load images:', err));

                // Load existing jobs
                fetch(`${API_BASE}/api/jobs`)
                    .then(res => res.json())
                    .then(data => setJobs(data.jobs || []))
                    .catch(err => console.error('Failed to load jobs:', err));
            }, []);

            // WebSocket connection
            const connectWebSocket = useCallback((jobId) => {
                if (wsRef.current) {
                    wsRef.current.close();
                }

                const wsUrl = `${WS_BASE}${window.location.host}/ws/${jobId}`;
                const ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    console.log('WebSocket connected');
                    wsReconnectAttempts.current = 0;
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        setActiveJob(prev => ({
                            ...prev,
                            ...data
                        }));

                        if (data.status === 'completed' || data.status === 'failed') {
                            ws.close();
                            // Reload job to get final state
                            fetch(`${API_BASE}/api/jobs/${jobId}`)
                                .then(res => res.json())
                                .then(job => {
                                    setActiveJob(job);
                                    setSelectedJob(job);
                                    setJobs(prev => {
                                        const idx = prev.findIndex(j => j.job_id === jobId);
                                        if (idx >= 0) {
                                            const newJobs = [...prev];
                                            newJobs[idx] = job;
                                            return newJobs;
                                        }
                                        return [...prev, job];
                                    });
                                });
                        }
                    } catch (err) {
                        console.error('Failed to parse WebSocket message:', err);
                    }
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };

                ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    // Auto-reconnect logic
                    if (wsReconnectAttempts.current < 3) {
                        wsReconnectAttempts.current++;
                        setTimeout(() => {
                            console.log(`Reconnecting... (attempt ${wsReconnectAttempts.current})`);
                            connectWebSocket(jobId);
                        }, 2000);
                    }
                };

                wsRef.current = ws;
            }, []);

            const handleUploadComplete = (newImages) => {
                setImages(prev => [...prev, ...newImages]);
            };

            const handleReorder = (newImages) => {
                setImages(newImages);
            };

            const handleDeleteImage = async (imageId) => {
                try {
                    await fetch(`${API_BASE}/api/images/${imageId}`, { method: 'DELETE' });
                    setImages(prev => prev.filter(img => img.id !== imageId));
                } catch (err) {
                    alert('ì´ë¯¸ì§€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                }
            };

            const handleGenerate = async (params) => {
                if (images.length < 2) {
                    alert('ìµœì†Œ 2ê°œ ì´ìƒì˜ ì´ë¯¸ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤');
                    return;
                }

                const jobRequest = {
                    image_ids: images.map(img => img.id),
                    ...params
                };

                try {
                    const response = await fetch(`${API_BASE}/api/jobs`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(jobRequest)
                    });

                    if (!response.ok) throw new Error('ì‘ì—… ìƒì„± ì‹¤íŒ¨');

                    const job = await response.json();
                    setActiveJob(job);
                    setJobs(prev => [job, ...prev]);
                    connectWebSocket(job.job_id);
                } catch (err) {
                    alert('ì‘ì—… ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
                }
            };

            const handleCancelJob = async (jobId) => {
                try {
                    await fetch(`${API_BASE}/api/jobs/${jobId}`, { method: 'DELETE' });
                    setActiveJob(null);
                    if (wsRef.current) {
                        wsRef.current.close();
                    }
                    // Reload jobs
                    const response = await fetch(`${API_BASE}/api/jobs`);
                    const data = await response.json();
                    setJobs(data.jobs || []);
                } catch (err) {
                    alert('ì‘ì—… ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                }
            };

            const handleSelectJob = (job) => {
                setSelectedJob(job);
            };

            const canGenerate = images.length >= 2 && (!activeJob || activeJob.status === 'completed' || activeJob.status === 'failed');

            return (
                <div className="min-h-screen bg-gray-900 p-4 md:p-8">
                    <div className="max-w-6xl mx-auto space-y-6">
                        {/* Header */}
                        <div className="text-center space-y-2">
                            <h1 className="text-3xl md:text-4xl font-bold text-blue-400">ğŸ¬ FramePack Video Studio</h1>
                            <div className="flex items-center justify-center gap-3 text-sm text-gray-400">
                                {systemConfig && (
                                    <span>GPU: {systemConfig.gpu_name} ({systemConfig.vram_gb}GB VRAM)</span>
                                )}
                                <a href="/monitor" target="_blank" className="text-blue-400 hover:text-blue-300 underline">
                                    GPU ëª¨ë‹ˆí„°
                                </a>
                            </div>
                        </div>

                        {/* Image Upload & Reorder */}
                        <div className="bg-gray-800 rounded-lg p-6 space-y-6">
                            <ImageUploader
                                onUploadComplete={handleUploadComplete}
                                systemConfig={systemConfig}
                            />
                            <ImageReorderer
                                images={images}
                                onReorder={handleReorder}
                                onDelete={handleDeleteImage}
                            />
                        </div>

                        {/* Parameter Panel */}
                        {images.length >= 2 && (
                            <ParameterPanel
                                systemConfig={systemConfig}
                                onGenerate={handleGenerate}
                                disabled={!canGenerate}
                            />
                        )}

                        {/* Progress Tracker */}
                        <ProgressTracker job={activeJob} onCancel={handleCancelJob} />

                        {/* Video Player */}
                        <VideoPlayer job={selectedJob} />

                        {/* Batch Queue */}
                        <BatchQueue jobs={jobs} onSelectJob={handleSelectJob} />
                    </div>
                </div>
            );
        };

        // Render App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
