<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPU 모니터 - FramePack Video Studio</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #111827; color: #e5e7eb; }
        .pulse-dot { animation: pulse-dot 2s ease-in-out infinite; }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const API_BASE = window.location.origin;

        function UsageBar({ label, used, total, unit, percent, color, height }) {
            const barColor = percent > 90 ? 'bg-red-500' : percent > 70 ? 'bg-yellow-500' : color;
            return (
                <div className="space-y-1.5">
                    <div className="flex justify-between text-sm">
                        <span className="text-gray-300 font-medium">{label}</span>
                        <span className="text-gray-400">{used} / {total} {unit} ({percent}%)</span>
                    </div>
                    <div className={`w-full bg-gray-700 rounded-full overflow-hidden`} style={{ height: height || '14px' }}>
                        <div
                            className={`${barColor} rounded-full transition-all duration-700 ease-out`}
                            style={{ width: `${Math.min(percent, 100)}%`, height: '100%' }}
                        />
                    </div>
                </div>
            );
        }

        function App() {
            const [monitor, setMonitor] = useState(null);
            const [error, setError] = useState(false);
            const [lastUpdate, setLastUpdate] = useState(null);

            useEffect(() => {
                let active = true;

                const fetchMonitor = async () => {
                    try {
                        const res = await fetch(`${API_BASE}/api/system/monitor`);
                        if (!res.ok) throw new Error();
                        const data = await res.json();
                        if (active) {
                            setMonitor(data);
                            setError(false);
                            setLastUpdate(new Date());
                        }
                    } catch {
                        if (active) setError(true);
                    }
                };

                fetchMonitor();
                const interval = setInterval(fetchMonitor, 4000);
                return () => { active = false; clearInterval(interval); };
            }, []);

            if (!monitor) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <p className="text-gray-500 text-lg">모니터 데이터 로딩 중...</p>
                    </div>
                );
            }

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-3xl mx-auto space-y-6">
                    {/* Header */}
                    <div className="flex items-center justify-between">
                        <div>
                            <h1 className="text-2xl font-bold text-blue-400">GPU 모니터</h1>
                            <p className="text-sm text-gray-500 mt-1">FramePack Video Studio</p>
                        </div>
                        <div className="flex items-center gap-4">
                            {error && <span className="text-xs text-red-400 bg-red-900/30 px-2 py-1 rounded">연결 오류</span>}
                            <a href="/" className="text-sm text-blue-400 hover:text-blue-300 underline">
                                스튜디오로 돌아가기
                            </a>
                        </div>
                    </div>

                    {/* VRAM Card */}
                    <div className="bg-gray-800 border border-gray-700 rounded-xl p-5 space-y-4">
                        <div className="flex items-center justify-between">
                            <h2 className="text-lg font-semibold text-gray-200">GPU VRAM</h2>
                            {monitor.gpu_utilization_percent > 0 && (
                                <span className="text-sm text-gray-400">
                                    GPU 사용률: <span className="text-white font-medium">{monitor.gpu_utilization_percent}%</span>
                                </span>
                            )}
                        </div>

                        <UsageBar
                            label="VRAM 사용량"
                            used={monitor.vram_used_gb}
                            total={monitor.vram_total_gb}
                            unit="GB"
                            percent={monitor.vram_usage_percent}
                            color="bg-emerald-500"
                        />

                        <div className="grid grid-cols-3 gap-3">
                            <div className="bg-gray-900 rounded-lg p-3 text-center">
                                <p className="text-xs text-gray-500">사용 중</p>
                                <p className="text-lg font-bold text-white">{monitor.vram_used_gb}<span className="text-sm text-gray-400 ml-1">GB</span></p>
                            </div>
                            <div className="bg-gray-900 rounded-lg p-3 text-center">
                                <p className="text-xs text-gray-500">여유</p>
                                <p className="text-lg font-bold text-emerald-400">{monitor.vram_free_gb}<span className="text-sm text-gray-400 ml-1">GB</span></p>
                            </div>
                            <div className="bg-gray-900 rounded-lg p-3 text-center">
                                <p className="text-xs text-gray-500">전체</p>
                                <p className="text-lg font-bold text-gray-300">{monitor.vram_total_gb}<span className="text-sm text-gray-400 ml-1">GB</span></p>
                            </div>
                        </div>

                        {/* PyTorch Memory */}
                        <div className="border-t border-gray-700 pt-3">
                            <p className="text-xs text-gray-500 mb-2">PyTorch 메모리</p>
                            <div className="grid grid-cols-2 gap-3">
                                <div className="flex justify-between text-sm">
                                    <span className="text-gray-400">할당됨</span>
                                    <span className="text-white">{monitor.torch_allocated_gb} GB</span>
                                </div>
                                <div className="flex justify-between text-sm">
                                    <span className="text-gray-400">예약됨</span>
                                    <span className="text-white">{monitor.torch_reserved_gb} GB</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* System RAM Card */}
                    <div className="bg-gray-800 border border-gray-700 rounded-xl p-5 space-y-4">
                        <h2 className="text-lg font-semibold text-gray-200">시스템 RAM</h2>

                        <UsageBar
                            label="RAM 사용량"
                            used={monitor.ram_used_gb}
                            total={monitor.ram_total_gb}
                            unit="GB"
                            percent={monitor.ram_usage_percent}
                            color="bg-blue-500"
                        />
                    </div>

                    {/* Active Job Card */}
                    <div className="bg-gray-800 border border-gray-700 rounded-xl p-5">
                        <h2 className="text-lg font-semibold text-gray-200 mb-3">현재 작업</h2>
                        {monitor.active_job_id ? (
                            <div className="space-y-3">
                                <div className="flex items-center gap-3">
                                    <span className="w-3 h-3 rounded-full bg-blue-500 pulse-dot"></span>
                                    <span className="text-blue-400 font-medium">{monitor.active_job_stage}</span>
                                </div>
                                <div className="space-y-1">
                                    <div className="flex justify-between text-sm text-gray-400">
                                        <span>Job {monitor.active_job_id.substring(0, 8)}</span>
                                        <span>{Math.round(monitor.active_job_progress)}%</span>
                                    </div>
                                    <div className="w-full bg-gray-700 rounded-full h-2 overflow-hidden">
                                        <div
                                            className="bg-blue-500 h-2 rounded-full transition-all duration-700"
                                            style={{ width: `${monitor.active_job_progress}%` }}
                                        />
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="flex items-center gap-3">
                                <span className="w-3 h-3 rounded-full bg-gray-600"></span>
                                <span className="text-gray-500">대기 중 - 실행 중인 작업 없음</span>
                            </div>
                        )}
                    </div>

                    {/* Footer */}
                    <div className="text-center text-xs text-gray-600">
                        {lastUpdate && (
                            <span>마지막 업데이트: {lastUpdate.toLocaleTimeString('ko-KR')} (4초 간격 자동 갱신)</span>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
